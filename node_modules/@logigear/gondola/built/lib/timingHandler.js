"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,i,t){void 0===t&&(t=i),Object.defineProperty(e,t,{enumerable:!0,get:function(){return r[i]}})}:function(e,r,i,t){void 0===t&&(t=i),e[t]=r[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var i in e)"default"!==i&&Object.hasOwnProperty.call(e,i)&&__createBinding(r,e,i);return __setModuleDefault(r,e),r},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.timing=exports.TimingOption=void 0;const ElementNotFound=require("codeceptjs/lib/helper/errors/ElementNotFound"),errors=__importStar(require("../errors")),errorHelper_1=require("../helper/utils/errorHelper"),util_1=require("../util"),rewire_1=__importDefault(require("rewire"));var TimingOption;!function(e){e[e.Visible=0]="Visible",e[e.Enable=1]="Enable",e[e.Clickable=2]="Clickable"}(TimingOption=exports.TimingOption||(exports.TimingOption={}));const defaultSmartwait=5e3;async function isVisible(e){return await(null==e?void 0:e.isDisplayed())}async function isEnable(e){return await(null==e?void 0:e.isEnabled())}async function isClickable(e){return await(null==e?void 0:e.isClickable())}async function timingWaiter(e,r,i,t){do{if(await e(r))return!0}while(Date.now()-i<t);return!1}function timing(e){return(r,i,t)=>{const l=t.value;return t.value=async function(...r){let t,n=[];try{beforeTiming(this,i,e,n),t=await l.apply(this,r)}catch(e){n.push(e)}finally{afterTiming(this,i)}if(n=errorHelper_1.filterError(i,n),n.length>0)throw n[0];return t},t}}function beforeTiming(e,r,i,t){const l=Date.now();switch(r){case"enter":overrideFillFieldFunc(e,r,i,l,t);break;default:overrideLocateFunc(e,r,i,l,t)}}function afterTiming(e,r){switch(r){case"enter":revertFillFieldFunc(e);break;default:revertLocateFunc(e)}}function overrideLocateFunc(e,r,i,t,l){if(!e)return;let n=e.myhelper;n||(n=e),void 0===n.helperLocate&&(n.helperLocate=n._locate),n._locate=async(e,o)=>{var a,s;let u=[];if(util_1.isEmpty(e)||e.isNull&&e.isNull())return l.push(new errors.LocatorEmptyError),u;const c=retrieveWaitTime(n);try{do{if(u=await(null===(a=n.helperLocate)||void 0===a?void 0:a.call(n,e,!1)),(null==u?void 0:u.length)>0)break}while(Date.now()-t<c)}catch(r){return l.push(new ElementNotFound(null!==(s=e.value)&&void 0!==s?s:e)),u}if(!u||0===u.length)return l.push(new errors.ElementNotFoundError(util_1.getLocatorString(e))),u;if(i.length>0)for(const l of i)switch(l){case TimingOption.Visible:if(!await timingWaiter(isVisible,null==u?void 0:u[0],t,c))throw new errors.GError(errors.GErrorKey.ElementNotEnabledOrDisplayed,e);break;case TimingOption.Enable:if(!await timingWaiter(isEnable,null==u?void 0:u[0],t,c))throw"enter"===r?new errors.GError(errors.GErrorKey.EnterDisableElementErr,e):new errors.GError(errors.GErrorKey.DisabledElementErr,e);break;case TimingOption.Clickable:if(!n.isWeb)break;if(!await timingWaiter(isClickable,null==u?void 0:u[0],t,c))throw new errors.GError(errors.GErrorKey.ElementNotEnabledOrDisplayed,e);break}return l.length=0,u}}function revertLocateFunc(e){if(!e)return;let r=e.myhelper;r||(r=e),r._locate=r.helperLocate,r.helperLocate=void 0}function overrideFillFieldFunc(e,r,i,t,l){if(!e)return;const n=e._getHelper();void 0===n.helperLocate&&(n.helperLocate=n._locate),n._locate=async(e,r)=>{var i;return await(null===(i=n.helperLocate)||void 0===i?void 0:i.call(n,e,!1))};const o=rewire_1.default("codeceptjs/lib/helper/WebDriver"),a=o.__get__("findFields"),s=async e=>{var o;let s=[];if(util_1.isEmpty(e)||e.isNull&&e.isNull())return l.push(new errors.LocatorEmptyError),s;const u=retrieveWaitTime(n);try{do{if(s=await a.call(n,e),(null==s?void 0:s.length)>0)break}while(Date.now()-t<u)}catch(r){return l.push(new ElementNotFound(null!==(o=e.value)&&void 0!==o?o:e)),s}return s&&0!==s.length?(await smartWaitWithOption(n,e,s,r,i,t,u),l.length=0,s):(l.push(new errors.ElementNotFoundError(util_1.getLocatorString(e))),s)},u=o.__get__("assertElementExists"),c=o.__get__("usingFirstElement"),d=async(e,r)=>{const i=await s.call(n,e);u(i,e,"Field");return c(i).setValue(r.toString())};"WebDriver"===n.constructor.name?(void 0===n.helperFillField&&(n.helperFillField=n.fillField),n.fillField=d):"AppiumEx"===n.constructor.name&&(void 0===n.helperFillField&&(n.helperFillField=n.__proto__.__proto__.__proto__.fillField),n.__proto__.__proto__.__proto__.fillField=d)}async function smartWaitWithOption(e,r,i,t,l,n,o){if(l.length>0)for(const a of l)switch(a){case TimingOption.Visible:if(!await timingWaiter(isVisible,null==i?void 0:i[0],n,o))throw new errors.GError(errors.GErrorKey.ElementNotEnabledOrDisplayed,r);break;case TimingOption.Enable:if(!await timingWaiter(isEnable,null==i?void 0:i[0],n,o))throw"enter"===t?new errors.GError(errors.GErrorKey.EnterDisableElementErr,r):new errors.GError(errors.GErrorKey.DisabledElementErr,r);break;case TimingOption.Clickable:if(!e.isWeb)break;if(!await timingWaiter(isClickable,null==i?void 0:i[0],n,o))throw new errors.GError(errors.GErrorKey.ElementNotEnabledOrDisplayed,r);break}}function revertFillFieldFunc(e){if(!e)return;const r=e._getHelper();r._locate=r.helperLocate,r.helperLocate=void 0,"WebDriver"===r.constructor.name?r.fillField=r.helperFillField:"AppiumEx"===r.constructor.name&&(r.__proto__.__proto__.__proto__.fillField=r.helperFillField),r.helperFillField=void 0}function retrieveWaitTime(e){var r;const i=null===(r=null==e?void 0:e.config)||void 0===r?void 0:r.smartWait;return Number.isInteger(i)&&i>=0?i:5e3}exports.timing=timing;
//# sourceMappingURL=../../debug/lib/timingHandler.js.map
